"use strict";(self.webpackChunkdoeks_website=self.webpackChunkdoeks_website||[]).push([[7919],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),p=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(i.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=p(n),m=r,h=c["".concat(i,".").concat(m)]||c[m]||u[m]||o;return n?a.createElement(h,l(l({ref:t},d),{},{components:n})):a.createElement(h,l({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=c;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var p=2;p<o;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},1553:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const o={sidebar_position:2,sidebar_label:"Ray on EKS"},l="Ray on EKS",s={unversionedId:"ai-ml-eks/ray",id:"ai-ml-eks/ray",title:"Ray on EKS",description:"This blueprint should be considered as experimental and should only be used for proof of concept.",source:"@site/docs/ai-ml-eks/ray.md",sourceDirName:"ai-ml-eks",slug:"/ai-ml-eks/ray",permalink:"/data-on-eks/docs/ai-ml-eks/ray",draft:!1,editUrl:"https://github.com/awslabs/data-on-eks/blob/main/website/docs/ai-ml-eks/ray.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,sidebar_label:"Ray on EKS"},sidebar:"docs",previous:{title:"Introduction",permalink:"/data-on-eks/docs/ai-ml-eks/"},next:{title:"Distributed Databases on EKS",permalink:"/data-on-eks/docs/category/distributed-databases-on-eks"}},i={},p=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Deploy the EKS Cluster with Ray Operator",id:"deploy-the-eks-cluster-with-ray-operator",level:2},{value:"Clone the repository",id:"clone-the-repository",level:3},{value:"Build Docker Image for Ray Cluster",id:"build-docker-image-for-ray-cluster",level:3},{value:"Initialize Terraform",id:"initialize-terraform",level:3},{value:"Terraform Plan",id:"terraform-plan",level:3},{value:"Deploy the pattern",id:"deploy-the-pattern",level:3},{value:"Verify Deployment",id:"verify-deployment",level:3},{value:"Ray Dashboard",id:"ray-dashboard",level:4},{value:"Examples",id:"examples",level:3},{value:"Hugging Face",id:"hugging-face",level:4},{value:"Ray Serve",id:"ray-serve",level:5},{value:"Test Summarize Deployment",id:"test-summarize-deployment",level:5},{value:"Pytorch HuggingFace Clothing",id:"pytorch-huggingface-clothing",level:4},{value:"Ray Train",id:"ray-train",level:5},{value:"Ray Serve",id:"ray-serve-1",level:5},{value:"Test Deployment",id:"test-deployment",level:5},{value:"Monitoring",id:"monitoring",level:3},{value:"Cleanup",id:"cleanup",level:2}],d={toc:p};function u(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"ray-on-eks"},"Ray on EKS"),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"This blueprint should be considered as experimental and should only be used for proof of concept.")),(0,r.kt)("p",null,"This ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/awslabs/data-on-eks/tree/main/ai-ml/terraform/ray"},"example")," deploys an EKS Cluster running the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ray.io/en/latest/"},"Ray Operator"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Creates a new sample VPC, 3 Private Subnets and 3 Public Subnets"),(0,r.kt)("li",{parentName:"ul"},"Creates Internet gateway for Public Subnets and NAT Gateway for Private Subnets"),(0,r.kt)("li",{parentName:"ul"},"Creates EKS Cluster Control plane with public endpoint (for demo reasons only) with one managed node group"),(0,r.kt)("li",{parentName:"ul"},"Deploys Ray Operator, AWS Load Balancer Controller, Ingress-nginx and External DNS (optional) add-ons"),(0,r.kt)("li",{parentName:"ul"},"Deploys a Ray Cluster in the ",(0,r.kt)("inlineCode",{parentName:"li"},"ray-cluster")," namespace")),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("p",null,"Ensure that you have installed the following tools on your machine."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html"},"aws cli")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://Kubernetes.io/docs/tasks/tools/"},"kubectl")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://learn.hashicorp.com/tutorials/terraform/install-cli"},"terraform")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://www.python.org/"},"python3")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://stedolan.github.io/jq/"},"jq"))),(0,r.kt)("p",null,"Additionally, for end-to-end configuration of Ingress, you can optionally provide the following:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"A ",(0,r.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/dns-configuring.html"},"Route53 Public Hosted Zone"),' configured in the account where you are deploying this example. E.g. "bar.com"'),(0,r.kt)("li",{parentName:"ol"},"An ",(0,r.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/acm/latest/userguide/gs-acm-request-public.html"},"ACM Certificate"),' in the account + region where you are deploying this example. A wildcard certificate is preferred, e.g. "*.bar.com"')),(0,r.kt)("h2",{id:"deploy-the-eks-cluster-with-ray-operator"},"Deploy the EKS Cluster with Ray Operator"),(0,r.kt)("h3",{id:"clone-the-repository"},"Clone the repository"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/awslabs/data-on-eks.git\n")),(0,r.kt)("h3",{id:"build-docker-image-for-ray-cluster"},"Build Docker Image for Ray Cluster"),(0,r.kt)("p",null,"First, in order to run the RayCluster, we need to push a container image to ECR repository that contains the all the dependencies. You can see the ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")," in the example with python dependencies packaged in. The next series of steps we will setup an ECR repository, build the docker image for our model and push it to the ECR repository."),(0,r.kt)("p",null,"Create an ECR repository"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"aws ecr create-repository --repository-name ray-demo\n")),(0,r.kt)("p",null,"Login to the ECR repository"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"export AWS_REGION=<enter-your-region>\nexport ACCOUNT_ID=$(aws sts get-caller-identity | jq -r '.Account')\necho $ACCOUNT_ID\n\naws ecr get-login-password \\\n  --region $AWS_REGION | docker login \\\n  --username AWS \\\n  --password-stdin $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/ray-demo\n")),(0,r.kt)("p",null,"Build the docker image containing our model deployment."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker build sources -t $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/ray-demo\n")),(0,r.kt)("p",null,"Push the docker image to the ECR repo"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker push $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/ray-demo\n")),(0,r.kt)("h3",{id:"initialize-terraform"},"Initialize Terraform"),(0,r.kt)("p",null,"Navigate into the example directory and run ",(0,r.kt)("inlineCode",{parentName:"p"},"terraform init")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd data-on-eks/ai-ml/terraform/ray/\nterraform init\n")),(0,r.kt)("h3",{id:"terraform-plan"},"Terraform Plan"),(0,r.kt)("p",null,"Run Terraform plan to verify the resources created by this execution."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Optional")," - provide a Route53 Hosted Zone hostname and a corresponding ACM Certificate;"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'export TF_VAR_eks_cluster_domain="bar.com"\nexport TF_VAR_acm_certificate_domain="*.bar.com"\n')),(0,r.kt)("h3",{id:"deploy-the-pattern"},"Deploy the pattern"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'terraform apply\n...\n...\n\nOutputs:\n\nconfigure_kubectl = "aws eks --region us-west-2 update-kubeconfig --name ray"\ns3_bucket = "ray-demo-models-20220719224423900800000001"\n')),(0,r.kt)("p",null,"Enter ",(0,r.kt)("inlineCode",{parentName:"p"},"yes")," to apply."),(0,r.kt)("p",null,"Export the s3_bucket to your local environment."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'export S3_BUCKET="s3://ray-demo-models-20220719224423900800000001"\n')),(0,r.kt)("h3",{id:"verify-deployment"},"Verify Deployment"),(0,r.kt)("p",null,"Update kubeconfig"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"aws eks --region us-west-2 update-kubeconfig --name ray\n")),(0,r.kt)("p",null,"Verify all pods are running."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"NAMESPACE               NAME                                                        READY   STATUS    RESTARTS        AGE\nexternal-dns            external-dns-99dd9564f-8fsvd                                1/1     Running   2 (6h21m ago)   16d\ningress-nginx           ingress-nginx-controller-659678ccb9-dlc5r                   1/1     Running   2 (6h20m ago)   16d\nkube-prometheus-stack   alertmanager-kube-prometheus-stack-alertmanager-0           2/2     Running   4 (6h21m ago)   16d\nkube-prometheus-stack   kube-prometheus-stack-grafana-68d4b6d7f4-h97j4              3/3     Running   6 (6h21m ago)   15d\nkube-prometheus-stack   kube-prometheus-stack-kube-state-metrics-6d6b967d6d-fc62f   1/1     Running   2 (6h21m ago)   16d\nkube-prometheus-stack   kube-prometheus-stack-operator-7c8bffbd9b-5rv59             1/1     Running   2 (6h21m ago)   14d\nkube-prometheus-stack   kube-prometheus-stack-prometheus-node-exporter-4hj6g        1/1     Running   2 (6h20m ago)   16d\nkube-prometheus-stack   kube-prometheus-stack-prometheus-node-exporter-9pgqc        1/1     Running   2 (6h21m ago)   16d\nkube-prometheus-stack   kube-prometheus-stack-prometheus-node-exporter-v46pf        1/1     Running   2 (6h21m ago)   16d\nkube-prometheus-stack   prometheus-kube-prometheus-stack-prometheus-0               2/2     Running   4 (6h21m ago)   14d\nkube-system             aws-load-balancer-controller-67b5dd7d69-jjq4r               1/1     Running   2 (6h21m ago)   16d\nkube-system             aws-load-balancer-controller-67b5dd7d69-pthpn               1/1     Running   2 (6h20m ago)   16d\nkube-system             aws-node-7bcvh                                              1/1     Running   3 (6h19m ago)   16d\nkube-system             aws-node-csshj                                              1/1     Running   3 (6h19m ago)   16d\nkube-system             aws-node-htcmn                                              1/1     Running   4 (6h19m ago)   16d\nkube-system             coredns-7f5998f4c-m4lxr                                     1/1     Running   2 (6h21m ago)   16d\nkube-system             coredns-7f5998f4c-t78m9                                     1/1     Running   2 (6h20m ago)   16d\nkube-system             kube-proxy-4v4pr                                            1/1     Running   2 (6h21m ago)   16d\nkube-system             kube-proxy-7rkb7                                            1/1     Running   2 (6h20m ago)   16d\nkube-system             kube-proxy-v76mj                                            1/1     Running   2 (6h21m ago)   16d\nkuberay-operator        kuberay-operator-7b88c9c4fb-kdhlz                           1/1     Running   2 (6h21m ago)   16d\nray-cluster             raycluster-autoscaler-head-wxbgw                            1/1     Running   0               10m\nray-cluster             raycluster-autoscaler-worker-large-group-twtld              1/1     Running   0               10m\n")),(0,r.kt)("h4",{id:"ray-dashboard"},"Ray Dashboard"),(0,r.kt)("p",null,'The Ray Dashboard can be opened at the following url "',(0,r.kt)("a",{parentName:"p",href:"https://ray-demo.bar.com/dashboard%22"},'https://ray-demo.bar.com/dashboard"')),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ray Dashboard",src:n(8753).Z,width:"1920",height:"953"})),(0,r.kt)("h3",{id:"examples"},"Examples"),(0,r.kt)("h4",{id:"hugging-face"},"Hugging Face"),(0,r.kt)("h5",{id:"ray-serve"},"Ray Serve"),(0,r.kt)("p",null,"As a sample, we will use ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ray.io/en/latest/serve/index.html"},"Ray Serve")," to deploy a sample machine learning model and expose it to the outside world via the Ingress configuration. The code for this deployment can be found ",(0,r.kt)("inlineCode",{parentName:"p"},"sources/hface_t5_summarize_serve.py"),". We use the ",(0,r.kt)("a",{parentName:"p",href:"https://huggingface.co/docs/transformers/model_doc/t5"},"Hugging Face T5")," model to serve an endpoint to summarize an arbitrary block of text. This model is deployed as Kubernetes job ",(0,r.kt)("inlineCode",{parentName:"p"},"sample-jobs/summarize-serve-job.yaml"),"."),(0,r.kt)("p",null,"Create a Job to deploy the model to the Ray Cluster"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"envsubst < sample-jobs/summarize-serve-job.yaml | kubectl create -f -\n\njob.batch/ray-summarize-job-cjdd8 created\n")),(0,r.kt)("p",null,"Tail the logs of the job to verify successful deployment of the job."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl logs -n ray-cluster ray-summarize-job-cjdd8-wmxm8 -f\n\nCaught schedule exception\n2022-07-08 17:03:29,579 INFO common.py:220 -- Exception from actor creation is ignored in destructor. To receive this exception in application code, call a method on the actor reference before its destructor is run.\n(ServeController pid=458) INFO 2022-07-08 17:03:30,684 controller 458 checkpoint_path.py:17 - Using RayInternalKVStore for controller checkpoint and recovery.\n(ServeController pid=458) INFO 2022-07-08 17:03:30,788 controller 458 http_state.py:115 - Starting HTTP proxy with name 'SERVE_CONTROLLER_ACTOR:SERVE_PROXY_ACTOR-node:10.0.12.204-0' on node 'node:10.0.12.204-0' listening on '0.0.0.0:8000'\n(HTTPProxyActor pid=496) INFO:     Started server process [496]\n(ServeController pid=458) INFO 2022-07-08 17:03:33,701 controller 458 deployment_state.py:1217 - Adding 1 replicas to deployment 'Summarizer'.\nDownloading: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1.17k/1.17k [00:00<00:00, 2.04MB/s]\nDownloading:   0%|          | 0.00/231M [00:00<?, ?B/s]\nDownloading:   2%|\u258f         | 5.68M/231M [00:00<00:03, 59.5MB/s]\nDownloading:   5%|\u258d         | 11.4M/231M [00:00<00:04, 47.3MB/s]\nDownloading:   7%|\u258b         | 16.0M/231M [00:00<00:04, 45.2MB/s]\nDownloading:   9%|\u2589         | 20.5M/231M [00:00<00:04, 45.9MB/s]\nDownloading:  11%|\u2588         | 25.8M/231M [00:00<00:04, 48.9MB/s]\nDownloading:  13%|\u2588\u258e        | 31.1M/231M [00:00<00:04, 51.2MB/s]\nDownloading:  16%|\u2588\u258c        | 36.4M/231M [00:00<00:03, 52.7MB/s]\nDownloading:  18%|\u2588\u258a        | 41.5M/231M [00:00<00:03, 52.7MB/s]\nDownloading:  20%|\u2588\u2588        | 46.6M/231M [00:00<00:03, 52.1MB/s]\nDownloading:  22%|\u2588\u2588\u258f       | 51.5M/231M [00:01<00:03, 51.5MB/s]\nDownloading:  25%|\u2588\u2588\u258d       | 56.6M/231M [00:01<00:03, 51.9MB/s]\nDownloading:  27%|\u2588\u2588\u258b       | 61.7M/231M [00:01<00:03, 52.3MB/s]\nDownloading:  29%|\u2588\u2588\u2589       | 66.9M/231M [00:01<00:03, 53.2MB/s]\nDownloading:  31%|\u2588\u2588\u2588       | 72.0M/231M [00:01<00:03, 51.1MB/s]\nDownloading:  33%|\u2588\u2588\u2588\u258e      | 76.9M/231M [00:01<00:03, 51.2MB/s]\nDownloading:  36%|\u2588\u2588\u2588\u258c      | 82.2M/231M [00:01<00:02, 52.5MB/s]\nDownloading:  38%|\u2588\u2588\u2588\u258a      | 87.3M/231M [00:01<00:02, 52.6MB/s]\nDownloading:  40%|\u2588\u2588\u2588\u2588      | 92.6M/231M [00:01<00:02, 53.5MB/s]\nDownloading:  42%|\u2588\u2588\u2588\u2588\u258f     | 97.7M/231M [00:01<00:02, 53.5MB/s]\nDownloading:  45%|\u2588\u2588\u2588\u2588\u258d     | 103M/231M [00:02<00:02, 54.2MB/s]\nDownloading:  47%|\u2588\u2588\u2588\u2588\u258b     | 108M/231M [00:02<00:02, 53.5MB/s]\nDownloading:  49%|\u2588\u2588\u2588\u2588\u2589     | 114M/231M [00:02<00:02, 54.3MB/s]\nDownloading:  51%|\u2588\u2588\u2588\u2588\u2588\u258f    | 119M/231M [00:02<00:02, 54.6MB/s]\nDownloading:  54%|\u2588\u2588\u2588\u2588\u2588\u258e    | 124M/231M [00:02<00:02, 54.8MB/s]\nDownloading:  56%|\u2588\u2588\u2588\u2588\u2588\u258c    | 129M/231M [00:02<00:01, 54.2MB/s]\nDownloading:  58%|\u2588\u2588\u2588\u2588\u2588\u258a    | 135M/231M [00:02<00:01, 54.7MB/s]\nDownloading:  61%|\u2588\u2588\u2588\u2588\u2588\u2588    | 140M/231M [00:02<00:01, 54.2MB/s]\nDownloading:  63%|\u2588\u2588\u2588\u2588\u2588\u2588\u258e   | 145M/231M [00:02<00:01, 53.2MB/s]\nDownloading:  65%|\u2588\u2588\u2588\u2588\u2588\u2588\u258c   | 150M/231M [00:02<00:01, 53.9MB/s]\nDownloading:  67%|\u2588\u2588\u2588\u2588\u2588\u2588\u258b   | 155M/231M [00:03<00:01, 44.7MB/s]\nDownloading:  70%|\u2588\u2588\u2588\u2588\u2588\u2588\u2589   | 161M/231M [00:03<00:01, 48.3MB/s]\nDownloading:  72%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258f  | 167M/231M [00:03<00:01, 51.2MB/s]\nDownloading:  74%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258d  | 172M/231M [00:03<00:01, 52.3MB/s]\nDownloading:  77%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258b  | 177M/231M [00:03<00:01, 50.8MB/s]\nDownloading:  79%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2589  | 182M/231M [00:03<00:00, 52.2MB/s]\nDownloading:  81%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258f | 188M/231M [00:03<00:00, 53.2MB/s]\nDownloading:  84%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258e | 193M/231M [00:03<00:00, 54.2MB/s]\nDownloading:  86%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c | 198M/231M [00:03<00:00, 53.9MB/s]\nDownloading:  88%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258a | 204M/231M [00:04<00:00, 53.6MB/s]\nDownloading:  90%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588 | 209M/231M [00:04<00:00, 53.5MB/s]\nDownloading:  93%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258e| 214M/231M [00:04<00:00, 54.0MB/s]\nDownloading:  95%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258d| 219M/231M [00:04<00:00, 54.6MB/s]\nDownloading:  97%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258b| 225M/231M [00:04<00:00, 54.8MB/s]\nDownloading: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 231M/231M [00:04<00:00, 52.5MB/s]\nDownloading: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 773k/773k [00:00<00:00, 29.1MB/s]\nDownloading: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1.32M/1.32M [00:00<00:00, 25.5MB/s]\n")),(0,r.kt)("h5",{id:"test-summarize-deployment"},"Test Summarize Deployment"),(0,r.kt)("p",null,"The client code uses python ",(0,r.kt)("inlineCode",{parentName:"p"},"requests")," module to invoke the ",(0,r.kt)("inlineCode",{parentName:"p"},"/summarize")," endpoint with a block of text. If all goes well, the endpoint should return summarized text of the block text submitted."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"python sources/summarize_client.py\n\ntwo astronauts steered their fragile lunar module safely and smoothly to the historic landing . the first men to reach the moon -- Armstrong and his co-pilot, col. Edwin E. Aldrin Jr. of the air force -- brought their ship to rest on a level, rock-strewn plain .\n")),(0,r.kt)("h4",{id:"pytorch-huggingface-clothing"},"Pytorch HuggingFace Clothing"),(0,r.kt)("h5",{id:"ray-train"},"Ray Train"),(0,r.kt)("p",null,"As a sample, we will use ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ray.io/en/latest/train/train.html"},"Ray Train")," to train a machine learning model using a sample dataset. See the code for model training ",(0,r.kt)("inlineCode",{parentName:"p"},"sources/train_pytorch_huggingface_clothing.py")),(0,r.kt)("p",null,"Create a Job to submit the training job to the Ray Cluster"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"envsubst < sample-jobs/train-pytorch-huggingface-clothing.yaml | kubectl create -f -\n\njob.batch/ray-train-pytorch-huggingface-clothing-plkzf created\n")),(0,r.kt)("p",null,"Tail the logs to see the training in progress:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl logs -n ray-cluster job.batch/ray-train-pytorch-huggingface-clothing-plkzf -f\n\n...\n...\n{'running_train_loss': tensor(1.1093, requires_grad=True), '_timestamp': 1660890352, '_time_this_iter_s': 32.8163115978241, '_training_iteration': 1, 'time_this_iter_s': 37.8390429019928, 'should_checkpoint': True, 'done': True, 'timesteps_total': None, 'episodes_total': None, 'training_iteration': 1, 'trial_id': 'af450_00000', 'experiment_id': '5a41dbb6558648d29ff5070c391167ea', 'date': '2022-08-18_23-25-54', 'timestamp': 1660890354, 'time_total_s': 37.8390429019928, 'pid': 1469, 'hostname': 'raycluster-autoscaler-head-wxbgw', 'node_ip': '10.0.11.68', 'config': {}, 'time_since_restore': 37.8390429019928, 'timesteps_since_restore': 0, 'iterations_since_restore': 1, 'warmup_time': 0.002658843994140625, 'experiment_tag': '0'}\ns3://ray-demo-models-20220801234005040500000001/ray_output/TorchTrainer_2022-08-18_23-25-13/TorchTrainer_af450_00000_0_2022-08-18_23-25-14/checkpoint_000000/\n\n")),(0,r.kt)("p",null,"As shown above a model checkpoint is written to an S3 location so that it can be retrived for model serving. The location of the checkpoint is stored in the SSM Parameter Store."),(0,r.kt)("h5",{id:"ray-serve-1"},"Ray Serve"),(0,r.kt)("p",null,"To create an inference endpoint which will be served using Ray Serve, create a Job to submit the Ray deployment ",(0,r.kt)("inlineCode",{parentName:"p"},"sources/serve_pytorch_huggingface_clothing.py"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"envsubst < sample-jobs/serve-pytorch-huggingface-clothing.yaml | kubectl create -f -\n\n")),(0,r.kt)("h5",{id:"test-deployment"},"Test Deployment"),(0,r.kt)("p",null,"A sample script ",(0,r.kt)("inlineCode",{parentName:"p"},"sources/pytorch_huggingface_clothing_client.py")," is provided that uses the requests library to test the inference endpoint."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"python sources/pytorch_huggingface_clothing_client.py\n\nPositive\n")),(0,r.kt)("h3",{id:"monitoring"},"Monitoring"),(0,r.kt)("p",null,"This blueprint uses the ",(0,r.kt)("inlineCode",{parentName:"p"},"kube-prometheus-stack")," to create a monitoring stack for getting visibility into your RayCluster."),(0,r.kt)("p",null,'Open the Grafana dashboard using the url "',(0,r.kt)("a",{parentName:"p",href:"https://ray-demo.bar.com/monitoring%22"},'https://ray-demo.bar.com/monitoring"'),". The sample Ray dashboard can be accessed by browsing to the Ray grafana folder."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ray Grafana Dashboard",src:n(148).Z,width:"1917",height:"916"})),(0,r.kt)("h2",{id:"cleanup"},"Cleanup"),(0,r.kt)("p",null,"To clean up your environment, destroy the Terraform modules in reverse order."),(0,r.kt)("p",null,"Destroy the Kubernetes Add-ons, EKS cluster with Node groups and VPC"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'terraform destroy -target="module.eks_blueprints_kubernetes_addons" -auto-approve\nterraform destroy -target="module.eks_blueprints" -auto-approve\nterraform destroy -target="module.vpc" -auto-approve\n')),(0,r.kt)("p",null,"Finally, destroy any additional resources that are not in the above modules"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"terraform destroy -auto-approve\n")))}u.isMDXComponent=!0},148:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/ray-grafana-0e24477b2a1da7e886df8c5bdc3100e8.png"},8753:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/ray-88e1cd5b5651d51bbe20e1ff0a41f102.png"}}]);